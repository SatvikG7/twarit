<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Explorer - TwaritTransfer</title>
        <link rel="stylesheet" href="/explore.css" />
    </head>

    <body>
        <div id="app">
            <header class="header">
                <div class="header-content">
                    <div class="logo-section">
                        <span class="emoji-icon">üìÅ</span>
                        <h1>File Explorer</h1>
                    </div>
                    <div class="breadcrumb-wrapper">
                        <div class="breadcrumb" id="breadcrumb"></div>
                    </div>
                </div>
            </header>

            <div class="toolbar">
                <div class="toolbar-left">
                    <button
                        class="btn btn-secondary"
                        id="go-back"
                        title="Go back"
                    >
                        <span class="emoji-icon">‚¨ÖÔ∏è</span>
                    </button>
                    <button
                        class="btn btn-secondary"
                        id="go-forward"
                        title="Go forward"
                    >
                        <span class="emoji-icon">‚û°Ô∏è</span>
                    </button>
                    <button
                        class="btn btn-secondary"
                        id="refresh"
                        title="Refresh"
                    >
                        <span class="emoji-icon">üîÑ</span>
                    </button>
                </div>
                <div class="toolbar-right">
                    <div class="view-toggle">
                        <button
                            class="btn btn-secondary active"
                            id="grid-view"
                            title="Grid view"
                        >
                            <span class="emoji-icon">‚äû</span>
                        </button>
                        <button
                            class="btn btn-secondary"
                            id="list-view"
                            title="List view"
                        >
                            <span class="emoji-icon">‚ò∞</span>
                        </button>
                    </div>
                    <div class="search-box">
                        <span class="search-icon">üîç</span>
                        <input
                            type="text"
                            placeholder="Search files..."
                            id="search-input"
                        />
                    </div>
                </div>
            </div>

            <main class="main-content">
                <div class="container" id="file-container"></div>
                <div class="loading" id="loading" style="display: none">
                    <span class="emoji-icon spinning">‚ö°</span>
                    <span>Loading files...</span>
                </div>
                <div class="empty-state" id="empty-state" style="display: none">
                    <span class="emoji-icon large">üìÇ</span>
                    <h3>This folder is empty</h3>
                    <p>No files or folders to display</p>
                </div>
            </main>
        </div>

        <script>
            // File type detection
            const getFileIcon = (fileName) => {
                const ext = fileName.split(".").pop().toLowerCase();
                const iconMap = {
                    // Documents
                    pdf: "üìÑ",
                    doc: "üìù",
                    docx: "üìù",
                    xls: "üìä",
                    xlsx: "üìä",
                    ppt: "üìΩÔ∏è",
                    pptx: "üìΩÔ∏è",
                    txt: "üìÑ",

                    // Images
                    jpg: "üñºÔ∏è",
                    jpeg: "üñºÔ∏è",
                    png: "üñºÔ∏è",
                    gif: "üñºÔ∏è",
                    svg: "üñºÔ∏è",
                    bmp: "üñºÔ∏è",
                    webp: "üñºÔ∏è",

                    // Videos
                    mp4: "üé¨",
                    avi: "üé¨",
                    mkv: "üé¨",
                    mov: "üé¨",
                    wmv: "üé¨",
                    flv: "üé¨",

                    // Audio
                    mp3: "üéµ",
                    wav: "üéµ",
                    flac: "üéµ",
                    aac: "üéµ",
                    ogg: "üéµ",

                    // Archives
                    zip: "üóúÔ∏è",
                    rar: "üóúÔ∏è",
                    "7z": "üóúÔ∏è",
                    tar: "üóúÔ∏è",
                    gz: "üóúÔ∏è",

                    // Code
                    js: "‚ö°",
                    html: "üåê",
                    css: "üé®",
                    py: "üêç",
                    java: "‚òï",
                    cpp: "‚öôÔ∏è",
                    c: "‚öôÔ∏è",
                    go: "üî∑",
                    php: "üêò",
                    rb: "üíé",
                    json: "üìã",
                    xml: "üìã",

                    // Executables
                    exe: "‚öôÔ∏è",
                    msi: "‚öôÔ∏è",
                    deb: "üì¶",
                    rpm: "üì¶",
                    dmg: "üíø",
                    iso: "üíø",
                };

                return iconMap[ext] || "üìÑ";
            };

            const formatFileSize = (size) => {
                if (!size) return "";
                const units = ["B", "KB", "MB", "GB", "TB"];
                let unitIndex = 0;
                while (size >= 1024 && unitIndex < units.length - 1) {
                    size /= 1024;
                    unitIndex++;
                }
                return `${size.toFixed(1)} ${units[unitIndex]}`;
            };

            const FILE = (name, path, size) => {
                const filePath = path === "/" ? `/${name}` : `${path}/${name}`;
                const iconEmoji = getFileIcon(name);
                const sizeText = size ? formatFileSize(size) : "";

                return `
                    <div class="item file-item" data-name="${name}" data-path="${filePath}" data-type="file" title="${name}${
                    sizeText ? ` (${sizeText})` : ""
                }">
                        <div class="item-icon">
                            <span class="emoji-icon">${iconEmoji}</span>
                        </div>
                        <div class="item-info">
                            <div class="item-name" title="${name}">${name}</div>
                            ${
                                sizeText
                                    ? `<div class="item-size" title="${sizeText}">${sizeText}</div>`
                                    : ""
                            }
                        </div>
                    </div>
                `;
            };

            const DIR = (name, path) => {
                const dirPath = path === "/" ? `/${name}` : `${path}/${name}`;
                return `
                    <div class="item directory-item" data-name="${name}" data-path="${dirPath}" data-type="directory" title="${name} (Folder)">
                        <div class="item-icon">
                            <span class="emoji-icon">üìÅ</span>
                        </div>
                        <div class="item-info">
                            <div class="item-name" title="${name}">${name}</div>
                            <div class="item-type">Folder</div>
                        </div>
                    </div>
                `;
            };

            // Navigation history
            let navigationHistory = [];
            let currentHistoryIndex = -1;

            // Get current path from URL
            const getCurrentPath = () => {
                const urlPath = window.location.pathname;
                if (urlPath === "/explore" || urlPath === "/explore/") {
                    return "/";
                }
                return urlPath.substring("/explore".length) || "/";
            };

            // Update breadcrumb navigation
            const updateBreadcrumb = (path) => {
                const breadcrumb = document.getElementById("breadcrumb");
                const parts =
                    path === "/"
                        ? ["C:"]
                        : ["C:", ...path.split("/").filter((p) => p)];

                breadcrumb.innerHTML = parts
                    .map((part, index) => {
                        const isLast = index === parts.length - 1;
                        const breadcrumbPath =
                            index === 0
                                ? "/"
                                : "/" + parts.slice(1, index + 1).join("/");

                        return `
                        <span class="breadcrumb-item ${isLast ? "active" : ""}" 
                              ${
                                  !isLast
                                      ? `data-path="${breadcrumbPath}" onclick="navigateToPath('${breadcrumbPath}')"`
                                      : ""
                              }>
                            ${part}
                        </span>
                        ${
                            !isLast
                                ? '<span class="breadcrumb-separator">‚Ä∫</span>'
                                : ""
                        }
                    `;
                    })
                    .join("");
            };

            // Update navigation buttons
            const updateNavigationButtons = () => {
                const backBtn = document.getElementById("go-back");
                const forwardBtn = document.getElementById("go-forward");

                backBtn.disabled = currentHistoryIndex <= 0;
                forwardBtn.disabled =
                    currentHistoryIndex >= navigationHistory.length - 1;
            };

            const showLoading = () => {
                document.getElementById("loading").style.display = "flex";
                document.getElementById("file-container").style.display =
                    "none";
                document.getElementById("empty-state").style.display = "none";
            };

            const hideLoading = () => {
                document.getElementById("loading").style.display = "none";
                document.getElementById("file-container").style.display =
                    "flex";
            };

            const showEmptyState = () => {
                document.getElementById("loading").style.display = "none";
                document.getElementById("file-container").style.display =
                    "none";
                document.getElementById("empty-state").style.display = "flex";
            };

            const loadFiles = async (path) => {
                showLoading();

                let apiPath = path === "/" ? "/" : path;

                try {
                    let response = await fetch(`/files${apiPath}`);
                    if (!response.ok) {
                        throw new Error(
                            `HTTP ${response.status}: ${response.statusText}`
                        );
                    }
                    let data = await response.json();
                    let container = document.getElementById("file-container");
                    container.innerHTML = "";

                    if (data.length === 0) {
                        showEmptyState();
                        return;
                    }

                    // Sort: directories first, then files alphabetically
                    data.sort((a, b) => {
                        if (a.isDir && !b.isDir) return -1;
                        if (!a.isDir && b.isDir) return 1;
                        return a.name.localeCompare(b.name);
                    });

                    // Add files and directories
                    data.forEach((file) => {
                        if (file.isDir) {
                            container.innerHTML += DIR(file.name, path);
                        } else {
                            container.innerHTML += FILE(
                                file.name,
                                path,
                                file.size
                            );
                        }
                    });

                    hideLoading();
                    attachEventListeners();
                } catch (error) {
                    hideLoading();
                    console.error("Error loading files:", error);
                    container.innerHTML = `
                        <div class="error-state">
                            <span class="emoji-icon large">‚ö†Ô∏è</span>
                            <h3>Error loading files</h3>
                            <p>${error.message}</p>
                            <button class="btn btn-primary" onclick="loadFiles('${path}')">
                                <span class="emoji-icon">üîÑ</span> Try Again
                            </button>
                        </div>
                    `;
                }
            };

            const attachEventListeners = () => {
                // Handle file and directory clicks
                document.querySelectorAll(".item").forEach((element) => {
                    element.onclick = (e) => {
                        e.preventDefault();
                        const name = element.dataset.name;
                        const path = element.dataset.path;
                        const type = element.dataset.type;

                        if (type === "directory") {
                            navigateToPath(path);
                        } else if (type === "file") {
                            window.open(`/files${path}`, "_blank");
                        }
                    };
                });
            };

            const navigateToPath = (path, addToHistory = true) => {
                if (addToHistory) {
                    // Remove any forward history if we're navigating to a new path
                    navigationHistory = navigationHistory.slice(
                        0,
                        currentHistoryIndex + 1
                    );
                    navigationHistory.push(path);
                    currentHistoryIndex = navigationHistory.length - 1;
                }

                const url = path === "/" ? "/explore" : `/explore${path}`;
                window.history.pushState({ path: path }, "", url);
                updateBreadcrumb(path);
                updateNavigationButtons();
                loadFiles(path);
            };

            // Initialize event listeners
            const initializeEventListeners = () => {
                // Navigation buttons
                document.getElementById("go-back").onclick = () => {
                    if (currentHistoryIndex > 0) {
                        currentHistoryIndex--;
                        const path = navigationHistory[currentHistoryIndex];
                        navigateToPath(path, false);
                    }
                };

                document.getElementById("go-forward").onclick = () => {
                    if (currentHistoryIndex < navigationHistory.length - 1) {
                        currentHistoryIndex++;
                        const path = navigationHistory[currentHistoryIndex];
                        navigateToPath(path, false);
                    }
                };

                document.getElementById("refresh").onclick = () => {
                    const currentPath = getCurrentPath();
                    loadFiles(currentPath);
                };

                // View toggle
                document.getElementById("grid-view").onclick = () => {
                    document
                        .getElementById("grid-view")
                        .classList.add("active");
                    document
                        .getElementById("list-view")
                        .classList.remove("active");
                    document.getElementById("file-container").className =
                        "container";
                };

                document.getElementById("list-view").onclick = () => {
                    document
                        .getElementById("list-view")
                        .classList.add("active");
                    document
                        .getElementById("grid-view")
                        .classList.remove("active");
                    document.getElementById("file-container").className =
                        "container list-view";
                };

                // Search functionality
                document.getElementById("search-input").oninput = (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    const items = document.querySelectorAll(".item");

                    items.forEach((item) => {
                        const name = item.dataset.name.toLowerCase();
                        if (name.includes(searchTerm)) {
                            item.style.display = "flex";
                        } else {
                            item.style.display = "none";
                        }
                    });
                };

                // Handle browser back/forward buttons
                window.addEventListener("popstate", (event) => {
                    const path = getCurrentPath();
                    updateBreadcrumb(path);
                    loadFiles(path);
                });
            };

            // Initialize on page load
            window.onload = () => {
                const currentPath = getCurrentPath();
                navigationHistory = [currentPath];
                currentHistoryIndex = 0;

                updateBreadcrumb(currentPath);
                updateNavigationButtons();
                loadFiles(currentPath);
                initializeEventListeners();
            };
        </script>
    </body>
</html>
